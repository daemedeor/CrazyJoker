extends ../layout

block content
  #table.clearfix.mdl-grid
    div#middle-of-table
      #deck.card(data-decktype="deck")

      #discard.card(data-decktype="discard")

    #me.clearfix.player-container
      .dealer
      .hand#me-hand(data-decktype="playerhand")
    
    #player-2.player-container
      .dealer
      .hand
        .card
        .card
        .card
        .card
        .card
        .card
        .card

    #player-3.player-container
      .dealer
      .hand
        .card
        .card
        .card
        .card
        .card
        .card
        .card

    #player-4.player-container
      .dealer
      .hand
        .card
        .card
        .card
        .card
        .card
        .card
        .card          
  #overlay
    .wrapper
      a#start-button.button(href="#") Start Game

      #shareRoom
        label(for="url") Room URL
        div(data-room="#{share}", id="room") #{shareURL}
  
  #await
    .wrapper
      #fountainTextG
        #fountainTextG_1.fountainTextG L
        #fountainTextG_2.fountainTextG o
        #fountainTextG_3.fountainTextG a
        #fountainTextG_4.fountainTextG d
        #fountainTextG_5.fountainTextG i
        #fountainTextG_6.fountainTextG n
        #fountainTextG_7.fountainTextG g
        #fountainTextG_8.fountainTextG .
        #fountainTextG_9.fountainTextG .
        #fountainTextG_10.fountainTextG .

block headerStyles
  link(rel="stylesheet", href="/css/dragula.min.css")
  link(rel="stylesheet", href="/css/jquery.fancybox.css")

block headerScripts
  script(src="/js/dragula.min.js")
  script(src="/js/jquery.fancybox.js")

block footerScripts

  script(src='/socket.io/socket.io.js')
  script(src='/js/frontEndLogic.js')

  script.
    $(function(){

      var IO = {
        init: function(){
          IO.socket = io.connect();
          IO.bindEvents();
        },

        bindEvents: function(){
          IO.socket.on('connected', IO.connected);
          IO.socket.on('goToLobby', IO.kickout);
          IO.socket.on('handSetUp', App.handSetup);
          IO.socket.on('setPlayer', App.setPlayer);
          IO.socket.on('startGame', App.startGame);
          IO.socket.on('contractDecided', IO.contractDecided);
        },
        
        kickout: kickout,
        connected: connected,
        contractDecided: contractDecided
      };

      var App = {
        
        //elements of the game
        draggableElements: ["#me.hand", "#deck", "#discard"],
        currentDeckObject: $("#deck"),
        table: $("#table"),
        myHand: $(".hand", "#me"),
        me: $("#me"),
        playerId: null,
        roomID: $("#room").data("room"),
        loading: $("#await"),
        overlay: $("#overlay"),
        startButton: $("#start-button"),
        fromHand: '',
        referencedElement: '',
        dragndrop: null,

        //functions registered to the app
        registerDragEvents: registerDragEvents,
        waiting: waiting,
        joinRoom: joinRoom,
        pullCard: pullCard,
        drag: drag,
        drop: drop,
        stopDragging: stopDragging,
        startGame: startGame,
        hideOverlays: hideOverlays,
        //- newRound: newRound,
        handSetup: handSetup,
        setPlayer: setPlayer,

        //functions that should remain defined on the table
        init: function() {

          App.overlay.show();

          var stringOfElements = App.draggableElements.join(",")
              , htmlToPassToDraggable = $(stringOfElements).toArray()
              , dragndrop;
          
          dragndrop = App.dragndrop = dragula(htmlToPassToDraggable);
          App.registerDragEvents(dragndrop);
          App.joinRoom();

        }
      }

      IO.init();

      App.startButton.click(function(e){
        e.preventDefault();
        IO.socket.emit("startGame");
      });

      function contractDecided() {
        App.waiting();
        IO.socket.emit('contractDecided');
      }

      function kickout() {
        window.location = "/lobby";
      }

      function connected() {
        App.init();
      }

      //App functions 
      function stopDragging() {
        dragndrop.end();
      }

      function startGame(data){
        App.hideOverlays();
        $.get("/contracts", {}, function(html){
            $.fancybox(html, { closeBtn: false, modal: true});
        });
      }

      function drop(el, target, source) {
        var dropLocation = $(target).data("decktype");

        if(App.pulledFrom == "playerhand" && dropLocation == "deck"){
          dragndrop.cancel(true);
          return;            
        }else if(dropLocation == "discard" && dropLocation != App.pulledFrom){
          var cardToDiscard = $(el).data("card");
          IO.socket.emit("discardCard", {room: App.gameId, pile: dropLocation, card: cardToDiscard})
          return;            
        }else if(dropLocation == "playerhand" && App.validMove){
          App.referencedElement = el;
          IO.socket.emit("addToHand", {player: App.currentPlayer, room: App.gameId});
          return;            
        }else if(dropLocation != "playerhand"){
          IO.socket.emit("placeBack", {room: App.gameId, deckType: dropLocation});
          $(el).remove();  
        }
      }

      function drag(el, source) {
        var dropLocation = $(source).data("decktype");

        App.pulledFrom = dropLocation;
        App.referencedElement = source;
        
        pullCard(dropLocation);
      }

      function pullCard(destination) {
        IO.socket.emit("pullACard", {room: App.gameId,  pile: dropLocation, playerId: App.currentPlayer});
      }

      function joinRoom() {
        IO.socket.emit("join", {room: App.roomID});
      };

      function waiting() {
        App.loading.show();
      }

      function hideOverlays() {
        App.loading.hide();
        App.overlay.hide();
      }

      function registerDragEvents(dragndrop) {
        dragndrop.on("cancel", App.drop);
        dragndrop.on("dragend", App.dragEnd);
        dragndrop.on("drag", App.drag);
        dragndrop.on("drop", App.drop);
      }

      function handSetup(data){
        
        App.myHand.empty();
        App.me.attr("data-id", data.id);

        data.hand.forEach(function(e,i,a){
          var text = e.split("_")[1];
          var newCard = "<div class='card "+ e +"'><p>"+text+"</p></div>"
          App.myHand.append(newCard);
        });

        setPlayer(data);
      }

      function setPlayer(data){
        var players = data.players;
        var ids = [];
        $('.player-container').each(function(){
          var currentId = $(this).data('id');
          if(currentId){
            ids.push(currentId);
          }
        });
        console.log(ids);
        players.forEach(function(e,i){
          var nextIndex = i+2;
          var currentPlayer = $("#player-"+ nextIndex, "#table");
          var id = currentPlayer.data("id");
          console.log(currentPlayer);
          if(!id && ids.indexOf(id) == -1){
            currentPlayer.attr('data-id', e);
          }
        });
      }
    });

  
